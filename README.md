# tcpmetrics

## Problem Description

- New Connection Detection: The definition of new connection is a unique(srcIP:srcPort -> dstIP:dstPort), meaning if one of these four entities are varied, then it counts as a new connection.

- Port Scan Detection: A port scan is defined as an anomaly which occurs for connections with a unique(srcIP -> dstIP) (key), where dstPort has over three values. There is no constraint over the dstPort numbers, there needs to be more than 3 destination port numbers for each key to be considered as a port scan.

## Solution Design

- The file /proc/net/tcp may be overwritten by the kernel while it is being read, so its best to not
glob the entire file, and read it line by line instead. Reads to this file are guarnteed to be atomic per line.
(source: https://stackoverflow.com/questions/5713451/is-it-safe-to-parse-a-proc-file ). Therefore, I opened the file as a read only file and parsed it line by line using bufio. 

- A file parser package was written to read the file and export the contents as a 2D array of strings, where
each element is a field between blank spaces in the row, and each row is represented by a 1D array of strings.

- A connection scanner object is used to detect new connections. This object dependson the tokens generated by file parser. The connection scanner function combs through the file and parses out the `ip:port` pairs in human readable format, and stores them in a set. The set is represented by a hashmap with a string key field and bool value, where the format of the string is `"srcIP:srcPort -> dstIP:dstPort"`.

- The connection scanner object contains a function to detect port scans. The port scanner accepts a list of tokens and parses `unique(srcIP -> dstIP)` (key) fields and stores them in a hashmap with a string key field, and string value field with the value field being a csv of destination port numbers. While collecting the destination port numbers, we ensure deduplication using a hashmap. The number of elements in this csv are counted to ensure that we send only those entries which have over three elements in this value field. The output of this function is a `hashmap[srcIP -> dstIP] = dstPorts`

## Testcase Specifications and Details

## Questions


## Improvements

-  Ideally this file should be parsed using a parsing library, by creating structs with the appropriate grammar.

- Convert IP function could be formalized to output better errors, and carry the IP and port in a struct, instead of
just using a string. Variable naming can be improved inside helper functions.

- Numbers in the convertIP and convertPort function could be written as constants.

- A db / in memory db may need to be used while doing this on a server which receives a large number of connections,
since data over six cycles of this program may get quite large.

- The port scan detection function works for a tuple(srcIP, dstIP) as unique keys and checks for multiple dstPort hits,
this does not take factor in possible source IP randomization / spoofing.
